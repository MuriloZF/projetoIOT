{% if privilegio == 1 %}
    {% extends "baseAdmin.html" %}
{% else %}
    {% extends "baseUser.html" %}    
{% endif %}

{% block title %} <title>Home - Dashboard</title> {% endblock %}

{% block body %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold text-center text-gray-800 dark:text-gray-100 mb-10">Painel de Controle Principal</h1>
    
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-8">
        <!-- Temperature Card -->
        <div class="bg-white dark:bg-gray-800 shadow-lg rounded-xl p-6 text-center hover:shadow-xl transition-shadow duration-300">
            <div class="flex justify-center items-center mb-4">
                <svg class="w-12 h-12 text-blue-500 dark:text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 12.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 18.75a.75.75 0 110-1.5.75.75 0 010 1.5z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 12.75h9m-9 3.75h9M3.375 19.5h17.25c.621 0 1.125-.504 1.125-1.125V5.625c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v12.75c0 .621.504 1.125 1.125 1.125z" />
                </svg>
            </div>
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-2">Temperatura Atual</h3>
            {# Use the sensor ID for the element ID #}
            <p id="sensor-{{ temperatura.id }}-value" class="text-3xl font-bold text-blue-600 dark:text-blue-400">{{ temperatura.value | default("N/A") }} {{ temperatura.unit | default("°C") }}</p>
            <p id="sensor-{{ temperatura.id }}-timestamp" class="text-sm text-gray-500 dark:text-gray-400 mt-1">Última atualização: {{ temperatura.timestamp | default("-") }}</p>
        </div>

        <!-- Humidity Card -->
        <div class="bg-white dark:bg-gray-800 shadow-lg rounded-xl p-6 text-center hover:shadow-xl transition-shadow duration-300">
            <div class="flex justify-center items-center mb-4">
                <svg class="w-12 h-12 text-green-500 dark:text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.258 10.041C15.258 11.883 14.015 14.19 12.43 15.775c-.49.49-1.17.49-1.66 0C9.195 14.19 7.953 11.883 7.953 10.041c0-2.48 2.01-4.491 4.49-4.491s4.49 2.01 4.49 4.491z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 17.25s.93-.93 2.036-2.036M12 17.25s-.93-.93-2.036-2.036" />
                </svg>
            </div>
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-2">Umidade do Ar</h3>
            {# Use the sensor ID for the element ID #}
            <p id="sensor-{{ umidade.id }}-value" class="text-3xl font-bold text-green-600 dark:text-green-400">{{ umidade.value | default("N/A") }} {{ umidade.unit | default("%") }}</p>
            <p id="sensor-{{ umidade.id }}-timestamp" class="text-sm text-gray-500 dark:text-gray-400 mt-1">Última atualização: {{ umidade.timestamp | default("-") }}</p>
        </div>

        <!-- Water Valve Card -->
        <div class="bg-white dark:bg-gray-800 shadow-lg rounded-xl p-6 text-center hover:shadow-xl transition-shadow duration-300">
            <div class="flex justify-center items-center mb-4">
                <svg class="w-12 h-12 text-purple-500 dark:text-purple-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h18M7.5 3L12 7.5m0 0L16.5 3M12 7.5V21" />
                </svg>
            </div>
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-2">{{ mangueira.name | default("Mangueira de Água") }}</h3>
            {# Use the actuator ID for the element ID #}
            <p id="actuator-{{ mangueira.id }}-status" class="text-3xl font-bold {% if mangueira.state == 'Ligado' %}text-green-500 dark:text-green-400{% else %}text-red-500 dark:text-red-400{% endif %}">
                {{ mangueira.state | default("Desconhecido") }}
            </p>
            {% if privilegio == 1 and mangueira.id %}
            <div class="flex justify-center space-x-2 mt-3">
                {# Pass the numerical actuator ID #}
                <button onclick="sendRawCommand({{ mangueira.id }}, 'ON')" 
                        class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-150">
                    ON
                </button>
                <button onclick="sendRawCommand({{ mangueira.id }}, 'OFF')" 
                        class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-150">
                    OFF
                </button>
            </div>
            {% endif %}
        </div>

        <!-- Ventilator Card -->
        <div class="bg-white dark:bg-gray-800 shadow-lg rounded-xl p-6 text-center hover:shadow-xl transition-shadow duration-300">
            <div class="flex justify-center items-center mb-4">
                <svg class="w-12 h-12 text-yellow-500 dark:text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    <circle cx="12" cy="12" r="3" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.512 7.576A9.005 9.005 0 0112 3m0 18a9.005 9.005 0 01-8.488-4.576M20.488 7.576A9.005 9.005 0 0012 3m0 18a9.005 9.005 0 008.488-4.576" />
                </svg>
            </div>
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-2">{{ ventilador.name | default("Ventilador") }}</h3>
            {# Use the actuator ID for the element ID #}
            <p id="actuator-{{ ventilador.id }}-status" class="text-3xl font-bold {% if ventilador.state == 'Ligado' %}text-green-500 dark:text-green-400{% else %}text-red-500 dark:text-red-400{% endif %}">
                {{ ventilador.state | default("Desconhecido") }}
            </p>
            {% if privilegio == 1 and ventilador.id %}
            <div class="flex justify-center space-x-2 mt-3">
                 {# Pass the numerical actuator ID #}
                <button onclick="sendRawCommand({{ ventilador.id }}, 'ON')" 
                        class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-150">
                    ON
                </button>
                <button onclick="sendRawCommand({{ ventilador.id }}, 'OFF')" 
                        class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-150">
                    OFF
                </button>
            </div>
            {% endif %}
        </div>

        <!-- Heater Card -->
        <div class="bg-white dark:bg-gray-800 shadow-lg rounded-xl p-6 text-center hover:shadow-xl transition-shadow duration-300">
            <div class="flex justify-center items-center mb-4">
                <svg class="w-12 h-12 text-orange-500 dark:text-orange-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.361-6.867 8.21 8.21 0 003 2.48z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 18a3.75 3.75 0 003.841-1.535.75.75 0 011.178-.821 5.25 5.25 0 001.021-5.707A3.75 3.75 0 0012 6a3.75 3.75 0 00-3.841 1.535.75.75 0 01-1.178.821A5.25 5.25 0 006.6 15.663 3.75 3.75 0 0012 18z" />
                </svg>
            </div>
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-2">{{ aquecedor.name | default("Aquecedor") }}</h3>
             {# Use the actuator ID for the element ID #}
            <p id="actuator-{{ aquecedor.id }}-status" class="text-3xl font-bold {% if aquecedor.state == 'Ligado' %}text-green-500 dark:text-green-400{% else %}text-red-500 dark:text-red-400{% endif %}">
                {{ aquecedor.state | default("Desconhecido") }}
            </p>
            {% if privilegio == 1 and aquecedor.id %}
            <div class="flex justify-center space-x-2 mt-3">
                 {# Pass the numerical actuator ID #}
                <button onclick="sendRawCommand({{ aquecedor.id }}, 'ON')" 
                        class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-150">
                    ON
                </button>
                <button onclick="sendRawCommand({{ aquecedor.id }}, 'OFF')" 
                        class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-150">
                    OFF
                </button>
            </div>
            {% endif %}
        </div>

        {% if privilegio == 1 %}
        <!-- User Management Card (Admin Only) -->
        <div class="bg-white dark:bg-gray-800 shadow-lg rounded-xl p-6 text-center hover:shadow-xl transition-shadow duration-300">
            <div class="flex justify-center items-center mb-4">
                <svg class="w-12 h-12 text-indigo-500 dark:text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
                </svg>
            </div>
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-2">Gerenciar Usuários</h3>
            <p class="text-gray-600 dark:text-gray-300 mb-3">Adicione ou remova usuários do sistema.</p>
            <a href="{{ url_for('user.manage_user_page') }}" class="mt-3 inline-block bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-150">Ir para Usuários</a>
        </div>
        {% endif %}
    </div>

    <div class="mt-12 text-center">
        {% if privilegio == 1 %}
        <p class="text-lg text-gray-700 dark:text-gray-300">Como administrador, você tem acesso a todas as funcionalidades de gerenciamento.</p>
        <a href="{{ url_for('detailed_dashboard_page') }}" class="mt-4 inline-block bg-custom-red hover:bg-custom-red-darker text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-150 text-lg">
            Acessar Controle Detalhado e Histórico
        </a>
        {% else %}
        <p class="text-lg text-gray-700 dark:text-gray-300">Bem-vindo ao seu painel de controle. Monitore seus dispositivos e ambientes.</p>
        <a href="{{ url_for('detailed_dashboard_page') }}" class="mt-4 inline-block bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-150 text-lg">
            Ver Dados Detalhados e Histórico
        </a>
        {% endif %}
    </div>
</div>

<script>
    // Function to send raw ON/OFF commands using numerical ID
    function sendRawCommand(actuatorDbId, rawCommand) {
        console.log(`Sending command: ${rawCommand} to actuator ID: ${actuatorDbId}`); // Debug log
        fetch("/api/actuator/raw_command", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ 
                actuator_id: actuatorDbId, // Send numerical DB ID
                raw_command: rawCommand 
            }),
        })
        .then(response => {
            if (!response.ok) {
                // Log error status and potentially the response body for debugging
                console.error(`Error response status: ${response.status}`);
                response.json().then(errData => console.error("Error response body:", errData)); 
            }
            return response.json();
        })
        .then(data => {
            console.log("Command response:", data);
            if (data.status === "success") {
                // Optimistically update the UI using the numerical ID
                const statusElement = document.getElementById(`actuator-${data.actuator_id}-status`); // Use numerical ID
                if (statusElement) {
                    statusElement.textContent = data.new_state;
                    statusElement.className = `text-3xl font-bold ${
                        data.new_state === "Ligado" 
                            ? "text-green-500 dark:text-green-400" 
                            : "text-red-500 dark:text-red-400"
                    }`;
                }
            } else {
                // Handle potential errors reported in the JSON response
                console.error(`Command failed: ${data.message}`);
                // Optionally show an error message to the user
            }
        })
        .catch(error => console.error("Error sending command:", error));
    }

    // Function to update all device data
    function updateDeviceData() {
        fetch("/api/device_data")
            .then(response => response.json())
            .then(data => {
                // Update Sensors using numerical ID
                Object.values(data.sensors).forEach(sensor => {
                    const valueElement = document.getElementById(`sensor-${sensor.id}-value`);
                    const timestampElement = document.getElementById(`sensor-${sensor.id}-timestamp`);
                    if (valueElement) {
                        valueElement.textContent = sensor.value + " " + (sensor.unit || "");
                    }
                    if (timestampElement) {
                        timestampElement.textContent = "Última atualização: " + sensor.timestamp;
                    }
                });

                // Update Actuators using numerical ID
                Object.values(data.actuators).forEach(actuator => {
                    const statusElement = document.getElementById(`actuator-${actuator.id}-status`);
                    if (statusElement) {
                        statusElement.textContent = actuator.state;
                        statusElement.className = `text-3xl font-bold ${
                            actuator.state === "Ligado" 
                                ? "text-green-500 dark:text-green-400" 
                                : "text-red-500 dark:text-red-400"
                        }`;
                    }
                });
            })
            .catch(error => console.error("Error fetching device data:", error));
    }

    // Initialize
    document.addEventListener("DOMContentLoaded", () => {
        updateDeviceData();
        setInterval(updateDeviceData, 3000); // Update every 3 seconds
    });
</script>
{% endblock %}
